# ./docker-compose.yml
services:

  postgres:
    image: postgres:14
    container_name: vectoradmin-postgres
    restart: always
    environment:
      POSTGRES_USER: vectoradmin
      POSTGRES_PASSWORD: vectoradmin123
      POSTGRES_DB: vdbms
    ports:
      - "5433:5432"
    volumes:
      - vectoradmin_pgdata:/var/lib/postgresql/data

  chromadb:
    build:
      context: .
      dockerfile: Dockerfile.chromadb
    container_name: chromadb
    ports:
      - "8000:8000"
    volumes:
      - chroma-data:/chroma
    restart: unless-stopped

  vectoradmin:
    image: ghcr.io/mintplex-labs/vector-admin:latest
    container_name: vectoradmin
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    environment:
      - SERVER_PORT=8080
      - JWT_SECRET=dev-mode-jwt-secret-keep-out-of-prod
      - INNGEST_EVENT_KEY=background_workers
      - INNGEST_SIGNING_KEY=dev-mode-signing-key
      - INNGEST_LANDING_PAGE=true
      - DB_TYPE=chroma
      - DB_HOST=chromadb
      - DB_PORT=8000
      - DATABASE_CONNECTION_STRING=postgresql://vectoradmin:vectoradmin123@postgres:5432/vdbms
      - DISABLE_TELEMETRY=true
    restart: always

  ingest-runner:
    build:
      context: ./ingest-runner
    container_name: ingest-runner
    image: whfr_ingest-runner
    volumes:
      - ./shared:/shared
      - pip-cache:/root/.cache/pip
    environment:
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
    depends_on:
      - ocr-helper
      - chromadb

  ocr-helper:
    build:
      context: ./ocr-helper
    image: whfr_ingest-runner
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
    container_name: ocr-helper
    depends_on:
      - openwebui
    volumes:
      - ./shared:/shared
      - pip-cache:/root/.cache/pip

  ollama:
    image: ollama/ollama
    container_name: ollama
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ollama_models:/root/.ollama
    ports:
      - "11434:11434"
    restart: always
    command: >
      sh -c "ollama pull nomic-embed-text && /bin/ollama serve"

  tika:
    image: apache/tika:latest
    container_name: tika
    ports:
      - "9998:9998"
    restart: always

  rag-api:
    build:
      context: ./rag-api
    ports:
      - "5050:5050"
    environment:
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - CHROMA_URL=http://chromadb:8000
    depends_on:
      - chromadb
      - ollama
    restart: always

  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: openwebui
    environment:
      - OLLAMA_API_BASE_URL=http://ollama:11434
      - GOOGLE_DRIVE_API_KEY=${GOOGLE_DRIVE_API_KEY}
      - GOOGLE_DRIVE_CLIENT_ID=${GOOGLE_DRIVE_CLIENT_ID}
      - GOOGLE_DRIVE_REDIRECT_URI=${GOOGLE_DRIVE_REDIRECT_URI}
    ports:
      - "3000:8080"
    depends_on:
      - ollama
      - chromadb
    volumes:
      - ./rag_tool.py:/app/plugins/rag_tool.py
      - ./rag_tool.json:/app/plugins/rag_tool.json
    restart: always

volumes:
  ollama_models:
  vectoradmin_pgdata:
  chroma-data:
  pip-cache:
